import os
import os
import subprocess
import time

import pandas as pd
from termcolor import colored


def shell(cmd):
    print("[shell]:", colored(cmd, "yellow"))
    return subprocess.run(cmd, shell=True, env={
        "srcdir": "/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/"
    })

def is_excluded(test_file,exclude_tests):
    for exclude_test in exclude_tests:
        if exclude_test in test_file:
            return True
    return False

if __name__=="__main__":
    # get all the files with extension ".sh" under tests, recursively
    test_files = []
    failed_tests=['tests/factor/create-test.sh', 'tests/du/one-file-system.sh', 'tests/install/basic-1.sh', 'tests/mv/leak-fd.sh', 'tests/mv/part-rename.sh', 'tests/mv/partition-perm.sh', 'tests/mv/to-symlink.sh', 'tests/mv/hard-link-1.sh', 'tests/mv/part-symlink.sh', 'tests/mv/into-self-2.sh', 'tests/mv/part-hardlink.sh', 'tests/mv/backup-is-src.sh', 'tests/mv/part-fail.sh', 'tests/mv/mv-special-1.sh', 'tests/misc/stat-birthtime.sh', 'tests/misc/close-stdout.sh', 'tests/misc/cat-buf.sh', 'tests/misc/help-version.sh', 'tests/tail-2/truncate.sh', 'tests/tail-2/retry.sh', 'tests/tail-2/overlay-headers.sh', 'tests/tail-2/F-headers.sh', 'tests/tail-2/F-vs-rename.sh', 'tests/tail-2/descriptor-vs-rename.sh', 'tests/tail-2/inotify-hash-abuse.sh', 'tests/tail-2/F-vs-missing.sh', 'tests/tail-2/assert.sh', 'tests/tail-2/assert-2.sh', 'tests/tail-2/symlink.sh', 'tests/cp/reflink-auto.sh', 'tests/dd/stats.sh']
    fatal_tests=['tests/rm/inaccessible.sh', 'tests/du/inaccessible-cwd.sh', 'tests/tail-2/inotify-race.sh', 'tests/tail-2/inotify-race2.sh']
    skipped_tests=['/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/id/gnu-zero-uids.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/id/smack.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/id/no-context.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/id/setgid.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/id/context.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t05.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t20.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/run.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t29.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t28.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t27.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t18.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t24.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t10.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t23.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t19.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t30.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t22.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t03.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t01.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t17.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t08.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t31.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t26.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t06.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t33.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t35.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t32.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t09.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t36.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t25.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t12.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t13.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t07.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t16.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t00.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t34.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t21.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t04.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t11.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t02.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t14.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/factor/t15.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/df/skip-rootfs.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/df/problematic-chars.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/df/over-mount-device.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/df/no-mtab-status.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/df/skip-duplicates.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/stat-free-color.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/nameless-uid.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/capability.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/no-cap.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/getxattr-speedup.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/ls/slink-acl.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/read-only.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/one-file-system.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/fail-2eperm.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/no-give-up.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/r-root.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/hash.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/rm-readdir-fail.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/many-dir-entries-vs-OOM.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/rm/ext3-perf.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/fd-leak.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/bind-mount-dir-cycle-v2.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/move-dir-while-traversing.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/2g.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/bind-mount-dir-cycle.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/du/bigtime.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/touch/now-owned-by-other.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/touch/no-dereference.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/install/install-Z-selinux.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/install/install-C-root.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/install/install-C-selinux.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mv/acl.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mv/sticky-to-xpart.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mv/hardlink-case.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/csplit-io-err.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-stale-thread-mem.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/stty-pairs.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-benchmark-random.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/xattr.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/selinux.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-h-thousands-sep.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/coreutils.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-u-FMR.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-compress-proc.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/truncate-owned-by-other.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-compress-hang.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/chroot-credentials.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-unique-segv.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/env-S-script.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/chcon.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/env.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/shuf-reservoir.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/tac-continue.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/seq-long-double.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/sort-spinlock-abuse.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/smack-no-root.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/smack-root.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/selinux.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/writable-under-readonly.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/p-acl.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/mkdir/restorecon.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/tail-2/big-4gb.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/tail-2/append-only.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/tail-2/inotify-dir-recreate.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/tail-2/inotify-only-regular.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/tail-2/end-of-device.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/chown/basic.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/cp-mv-enotsup-xattr.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/link-heap.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/fiemap-perf.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/preserve-gid.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/fiemap-FMR.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/no-ctx.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/acl.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/special-bits.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/preserve-slink-time.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/nfs-removal-race.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/fiemap-extents.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/capability.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/sparse-fiemap.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/cp-a-selinux.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/perm.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/fiemap-2.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/cp/cross-dev-symlink.sh', '/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/dd/skip-seek-past-dev.sh']
    hang_tests=["/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests/misc/tee.sh"]
    long_tests=["sort-float.sh"]    
    exclude_tests=[]
    exclude_tests.extend(failed_tests)
    exclude_tests.extend(fatal_tests)
    exclude_tests.extend(long_tests)   
    exclude_tests.extend(skipped_tests)
    exclude_tests.extend(hang_tests)
    for root, dirs, files in os.walk("/home/ubuntu/repos/file_level_bloat/experiment/workloads/repos/coreutils-8.30/tests"):
        for file in files:
             if file.endswith(".sh"):
                test_file=os.path.join(root, file)
                if not is_excluded(test_file,exclude_tests):
                    test_files.append(test_file)
    stats={
        "PASS":[],
        "FAIL":[],
        "SKIP":[],
        "FATAL":[]
    }
    cnt=0
    test_files=test_files[:280] # or else it takes too long
    print("Total test files:", test_files)
    for test_file in test_files:
        start=time.time()
        print(f"Running test: {test_file}")
        proc=shell(test_file)
        retcode=proc.returncode
        if retcode==0:
            print(f"PASS: {test_file}")
            stats["PASS"].append(test_file)
        elif retcode==1:
            print(f"FAIL: {test_file}")
            stats["FAIL"].append(test_file)
        elif retcode==77:
            print(f"SKIP: {test_file}")
            stats["SKIP"].append(test_file)
        elif retcode==99:
            print(f"FATAL: {test_file}")
            stats["FATAL"].append(test_file)
        cnt+=1
        end=time.time()
        print(f"Progress: {cnt}/{len(test_files)}, {test_file}, Time: {end-start}")

    print("PASSED TESTS:",len(stats["PASS"]))
    print("FAILED TESTS:",len(stats["FAIL"]))
    print("SKIPPED TESTS:",len(stats["SKIP"]))
    print("FATAL TESTS:",len(stats["FATAL"]))

    print("FAILED TESTS:", stats["FAIL"])
    print("FATAL TESTS:", stats["FATAL"])
    print("SKIPPED TESTS:", stats["SKIP"])
    
    

